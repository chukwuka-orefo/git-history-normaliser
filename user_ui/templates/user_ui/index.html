<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Git History Synth</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
  </head>

  <body class="bg-light">
    <div class="container py-4">
      <div class="mb-3">
        <h1 class="h3 mb-1">Git History Synth</h1>
        <div class="text-muted">
          Configure a policy, preview changes, then rewrite timestamps.
        </div>
      </div>

      {% if browse_error %}
        <div class="alert alert-warning">
          {{ browse_error }}
        </div>
      {% endif %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <form method="post" novalidate>
        {% csrf_token %}

        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h2 class="h5 mb-3">Repository</h2>

            <div class="mb-3">
              <label class="form-label" for="{{ form.repo_path.id_for_label }}">{{ form.repo_path.label }}</label>

              <div class="input-group">
                {{ form.repo_path }}
                <button class="btn btn-outline-secondary" name="action" value="browse_repo" type="submit" formnovalidate>
                  Browseâ€¦
                </button>
              </div>

              {% if form.repo_path.help_text %}
                <div class="form-text">{{ form.repo_path.help_text }}</div>
              {% endif %}
              {% if form.repo_path.errors %}
                <div class="text-danger small">{{ form.repo_path.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h2 class="h5 mb-3">Mode</h2>

            <div class="mb-3">
              {% for radio in form.mode %}
                <div class="form-check">
                  {{ radio.tag }}
                  <label class="form-check-label" for="{{ radio.id_for_label }}">
                    {{ radio.choice_label }}
                  </label>
                </div>
              {% endfor %}
              {% if form.mode.errors %}
                <div class="text-danger small">{{ form.mode.errors }}</div>
              {% endif %}
            </div>

            <button
              class="btn btn-outline-secondary btn-sm"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#advancedPanel"
              aria-expanded="false"
              aria-controls="advancedPanel"
            >
              Advanced
            </button>

            <div class="collapse mt-3" id="advancedPanel">
              <div class="border rounded p-3 bg-white">
                <div class="mb-3">
                  <label class="form-label" for="{{ form.scope_fraction.id_for_label }}">{{ form.scope_fraction.label }}</label>
                  {{ form.scope_fraction }}
                  {% if form.scope_fraction.help_text %}
                    <div class="form-text">{{ form.scope_fraction.help_text }}</div>
                  {% endif %}
                  {% if form.scope_fraction.errors %}
                    <div class="text-danger small">{{ form.scope_fraction.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="card shadow-sm mb-3" id="syntheticPanel">
          <div class="card-body">
            <h2 class="h5 mb-3">Synthetic configuration</h2>
            <div class="text-muted mb-3">
              This section is only active when Synthetic mode is selected.
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label" for="{{ form.calendar_start.id_for_label }}">{{ form.calendar_start.label }}</label>
                {{ form.calendar_start }}
                {% if form.calendar_start.errors %}
                  <div class="text-danger small">{{ form.calendar_start.errors }}</div>
                {% endif %}
              </div>

              <div class="col-md-6">
                <label class="form-label" for="{{ form.calendar_end.id_for_label }}">{{ form.calendar_end.label }}</label>
                {{ form.calendar_end }}
                {% if form.calendar_end.errors %}
                  <div class="text-danger small">{{ form.calendar_end.errors }}</div>
                {% endif %}
              </div>
            </div>

            {{ form.calendar_timezone }}

            <hr class="my-4" />

            <h3 class="h6 mb-3">Work patterns</h3>

            <div class="border rounded p-3 bg-white mb-3">
              <div class="form-check mb-2">
                {{ form.weekdays_enabled }}
                <label class="form-check-label" for="{{ form.weekdays_enabled.id_for_label }}">Weekdays enabled</label>
              </div>

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" for="{{ form.weekdays_start.id_for_label }}">Start</label>
                  {{ form.weekdays_start }}
                  {% if form.weekdays_start.errors %}
                    <div class="text-danger small">{{ form.weekdays_start.errors }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="{{ form.weekdays_end.id_for_label }}">End</label>
                  {{ form.weekdays_end }}
                  {% if form.weekdays_end.errors %}
                    <div class="text-danger small">{{ form.weekdays_end.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="border rounded p-3 bg-white mb-3">
              <div class="form-check mb-2">
                {{ form.saturday_enabled }}
                <label class="form-check-label" for="{{ form.saturday_enabled.id_for_label }}">Saturday enabled</label>
              </div>

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" for="{{ form.saturday_start.id_for_label }}">Start</label>
                  {{ form.saturday_start }}
                  {% if form.saturday_start.errors %}
                    <div class="text-danger small">{{ form.saturday_start.errors }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="{{ form.saturday_end.id_for_label }}">End</label>
                  {{ form.saturday_end }}
                  {% if form.saturday_end.errors %}
                    <div class="text-danger small">{{ form.saturday_end.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="border rounded p-3 bg-white mb-3">
              <div class="form-check mb-2">
                {{ form.sunday_enabled }}
                <label class="form-check-label" for="{{ form.sunday_enabled.id_for_label }}">Sunday enabled</label>
              </div>

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label" for="{{ form.sunday_start.id_for_label }}">Start</label>
                  {{ form.sunday_start }}
                  {% if form.sunday_start.errors %}
                    <div class="text-danger small">{{ form.sunday_start.errors }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="{{ form.sunday_end.id_for_label }}">End</label>
                  {{ form.sunday_end }}
                  {% if form.sunday_end.errors %}
                    <div class="text-danger small">{{ form.sunday_end.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <button
              class="btn btn-outline-secondary btn-sm"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#randomnessPanel"
              aria-expanded="false"
              aria-controls="randomnessPanel"
            >
              Advanced randomness
            </button>

            <div class="collapse mt-3" id="randomnessPanel">
              <div class="border rounded p-3 bg-white">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label" for="{{ form.randomness_seed.id_for_label }}">Seed</label>
                    {{ form.randomness_seed }}
                    {% if form.randomness_seed.errors %}
                      <div class="text-danger small">{{ form.randomness_seed.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-4">
                    <label class="form-label" for="{{ form.gap_minutes_min.id_for_label }}">Gap minutes min</label>
                    {{ form.gap_minutes_min }}
                    {% if form.gap_minutes_min.errors %}
                      <div class="text-danger small">{{ form.gap_minutes_min.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-4">
                    <label class="form-label" for="{{ form.gap_minutes_max.id_for_label }}">Gap minutes max</label>
                    {{ form.gap_minutes_max }}
                    {% if form.gap_minutes_max.errors %}
                      <div class="text-danger small">{{ form.gap_minutes_max.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6">
                    <label class="form-label" for="{{ form.seconds_min.id_for_label }}">Seconds min</label>
                    {{ form.seconds_min }}
                    {% if form.seconds_min.errors %}
                      <div class="text-danger small">{{ form.seconds_min.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6">
                    <label class="form-label" for="{{ form.seconds_max.id_for_label }}">Seconds max</label>
                    {{ form.seconds_max }}
                    {% if form.seconds_max.errors %}
                      <div class="text-danger small">{{ form.seconds_max.errors }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h2 class="h5 mb-3">Actions</h2>

            <div class="row g-2">
              <div class="col-sm-auto">
                <button class="btn btn-outline-primary" name="action" value="preview_yaml" type="submit">
                  Preview YAML
                </button>
              </div>

              <div class="col-sm-auto">
                <button class="btn btn-primary" name="action" value="dry_run" type="submit">
                  Dry run
                </button>
              </div>

              <div class="col-sm-auto">
                <button class="btn btn-danger" name="action" value="rewrite" type="submit">
                  Rewrite
                </button>
              </div>
            </div>

            <div class="mt-3">
              <div class="form-check">
                {{ form.allow_dirty }}
                <label class="form-check-label" for="{{ form.allow_dirty.id_for_label }}">Allow dirty working tree</label>
              </div>
              <div class="form-check">
                {{ form.confirm_rewrite }}
                <label class="form-check-label" for="{{ form.confirm_rewrite.id_for_label }}">
                  I understand this rewrites Git history
                </label>
                {% if form.confirm_rewrite.errors %}
                  <div class="text-danger small">{{ form.confirm_rewrite.errors }}</div>
                {% endif %}
              </div>
            </div>

          </div>
        </div>

      </form>

      {% if yaml_preview_text %}
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h2 class="h5 mb-3">YAML preview</h2>
            <textarea class="form-control font-monospace" rows="14" readonly>{{ yaml_preview_text }}</textarea>
          </div>
        </div>
      {% endif %}

      {% if command_result %}
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h2 class="h5 mb-3">Command output</h2>

            <div class="mb-2">
              <div class="small text-muted">
                Return code: {{ command_result.returncode }}
              </div>
              <div class="small text-muted">
                Command: {{ command_result.cmd|join:" " }}
              </div>
            </div>

            {% if command_result.stdout %}
              <div class="mb-3">
                <div class="small text-muted mb-1">stdout</div>
                <pre class="bg-dark text-light p-3 rounded" style="white-space: pre-wrap;">{{ command_result.stdout }}</pre>
              </div>
            {% endif %}

            {% if command_result.stderr %}
              <div class="mb-3">
                <div class="small text-muted mb-1">stderr</div>
                <pre class="bg-dark text-light p-3 rounded" style="white-space: pre-wrap;">{{ command_result.stderr }}</pre>
              </div>
            {% endif %}

          </div>
        </div>
      {% endif %}

    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>

    <script>
      function setSyntheticEnabled(enabled) {
        const panel = document.getElementById("syntheticPanel");
        if (!panel) return;

        panel.style.display = enabled ? "block" : "none";

        const inputs = panel.querySelectorAll("input, select, textarea");
        inputs.forEach((el) => {
          el.disabled = !enabled;
        });
      }

      function updateModeUI() {
        const checked = document.querySelector('input[name="mode"]:checked');
        const mode = checked ? checked.value : "author";
        setSyntheticEnabled(mode === "synthetic");
      }

      document.addEventListener("DOMContentLoaded", () => {
        const radios = document.querySelectorAll('input[name="mode"]');
        radios.forEach((r) => r.addEventListener("change", updateModeUI));
        updateModeUI();
      });
    </script>
  </body>
</html>
